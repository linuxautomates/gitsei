package io.levelops.internal_api.services;

import io.levelops.commons.databases.models.database.WorkItem;
import io.levelops.commons.utils.ResourceUtils;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mockito;

import java.io.IOException;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;

public class SnippetWorkItemSlackMessageBuilderTest {
    private static final String COMPANY = "test";
    private static final String APP_BASE_URL = "https://testui1.levelops.io";
    private static final List<String> STATES = List.of("CLOSED","OPEN","IN_REVIEW","NEW","Not Yet Reviewed","WIP");
    private static final String WI_ID = "5a94ff29-3556-43a7-97e2-e367da654d44";
    private static final String UPLOAD_ID = "22a3ce26-2178-4c73-bea9-c6b75728d1f7";

    private static final String REQUESTOR = "viraj@levelops.io";
    private static final String CUSTOM_MESSAGE = "Could you please take a look at this error?";

    private final RandomStringGenerator randomStringGenerator = Mockito.mock(RandomStringGenerator.class);
    private final Map<UUID, String> uploadIdTextAttachmentsMap;

    public SnippetWorkItemSlackMessageBuilderTest() throws IOException {
        this.uploadIdTextAttachmentsMap = Map.of(UUID.fromString(UPLOAD_ID), ResourceUtils.getResourceAsString("workitems/workitem_snippet_long.txt"));
    }

    @Before
    public void setup() {
        Mockito.when(randomStringGenerator.randomString()).thenReturn("aJVeRkULBu","gbqB9kp4Tv","8i5Mv0NzWV","1lwAncRZtR","mTDL2DN2m7","FDGCq38XRE");
        Map.of(UUID.fromString(UPLOAD_ID), "anmabmabmna \n akjhakjahjka \n hksjhkjshsjksh\n");
    }

    @Test
    public void testWISnippet() {
        WorkItem wi = WorkItem.builder()
                .id(WI_ID)
                .type(WorkItem.ItemType.MANUAL).ticketType(WorkItem.TicketType.SNIPPET)
                .vanityId("KAFKA-123")
                .title("Snippet from jenkins.dev.levelops.io")
                .reason("https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console")
                .attachment(WorkItem.Attachment.builder().fileName("Really really really really loooooooooooooooooooooooooooooooooooog name.txt").uploadId(UPLOAD_ID).build())
                .build();
        SnippetWorkItemSlackMessageBuilder builder = new SnippetWorkItemSlackMessageBuilder(randomStringGenerator);
        WorkItemSlackMessageBuilder.WorkItemSlackMessages workItemSlackMessages = builder.buildInteractiveMessage(COMPANY, APP_BASE_URL, wi, STATES, uploadIdTextAttachmentsMap, REQUESTOR, CUSTOM_MESSAGE);
        String actual = workItemSlackMessages.getMessage();
        assertThat(actual).isEqualTo("[{\"block_id\": \"NOOP_aJVeRkULBu\",\"type\": \"divider\"},{\"block_id\": \"NOOP_REQUESTOR\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"From viraj@levelops.io,\"}},{\"block_id\": \"NOOP_TITLELEVELOPSWIURL\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"<https://testui1.levelops.io/#/admin/workitems/details?workitem=KAFKA-123|Snippet from jenkins.dev.levelops.io>\"}},{\"block_id\": \"NOOP_MESSAGE\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"Could you please take a look at this error?\"}},{\"block_id\": \"NOOP_URL\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"<https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console|https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console>\"}},{\"block_id\": \"NOOP_SNIPPETPREVIEW\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"```2020-11-06 17:41:00.250 ERROR 1 --- [ctivity-event-2] i.l.a.s.SlackInteractivityEventService   : Error sending answer questionnaire inline modal!\\n\\nio.levelops.notification.clients.SlackClientException: Response not successful: SlackApiResponse(ok=false, payload=SlackApiViewResponse(view=null), dynamicProperties={response_metadata={messages=[[ERROR] failed to match all allowed schemas [json-pointer:\\/view], [ERROR] failed to match all allowed schemas [json-pointer:\\/view\\/title], [ERROR] must be less than 25 characters [json-pointer:\\/view\\/title\\/text]]}...```\"}},{\"block_id\": \"workitem_snippet\",\"type\": \"actions\",\"elements\": [{\"type\": \"button\",\"text\": {\"type\": \"plain_text\",\"text\": \"View Entire Snippet\",\"emoji\": true},\"style\": \"primary\",\"value\": \"view_wi_text_attachment~@@@_test~@@@_5a94ff29-3556-43a7-97e2-e367da654d44~@@@_22a3ce26-2178-4c73-bea9-c6b75728d1f7\",\"action_id\": \"view_wi_text_attachment\"}]},{\"block_id\": \"change_status_snippet_ticket\", \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"`Approval Decision:`\" }, \"accessory\": {\"action_id\": \"change_status_snippet_ticket\",\"type\": \"static_select\", \"placeholder\": { \"type\": \"plain_text\", \"text\": \"Select an item\", \"emoji\": true }, \"options\": [ { \"text\": { \"type\": \"plain_text\", \"text\": \"Closed\", \"emoji\": true }, \"value\": \"CLOSED\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"Open\", \"emoji\": true }, \"value\": \"OPEN\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"In Review\", \"emoji\": true }, \"value\": \"IN_REVIEW\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"New\", \"emoji\": true }, \"value\": \"NEW\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"Not Yet Reviewed\", \"emoji\": true }, \"value\": \"Not Yet Reviewed\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"WIP\", \"emoji\": true }, \"value\": \"WIP\" } ] } },{\"block_id\": \"forward_snippet_ticket\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"`Forward To:`\"},\"accessory\": {\"action_id\": \"forward_snippet_ticket\",\"type\": \"multi_conversations_select\",\"placeholder\": {\"type\": \"plain_text\",\"text\": \"Select conversations\",\"emoji\": true}}},{\"block_id\":\"assign_snippet_ticket\",\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"`Assign To :`\"},\"accessory\":{\"action_id\":\"assignee_select_snippet_ticket\",\"type\":\"users_select\",\"placeholder\":{\"type\":\"plain_text\",\"text\":\"Select assignee\",\"emoji\":true}}}]");
        assertThat(workItemSlackMessages.getModalMessages().size()).isEqualTo(1);
        assertThat(workItemSlackMessages.getModalMessages().get(0).getLeft()).isEqualTo(UUID.fromString(UPLOAD_ID));
        assertThat(workItemSlackMessages.getModalMessages().get(0).getRight()).isEqualTo("{\"title\": {\"type\": \"plain_text\",\"text\": \"Really really reall...\"},\"blocks\": [{\"block_id\": \"NOOP_gbqB9kp4Tv\",\"type\": \"divider\"},{\"block_id\": \"NOOP_8i5Mv0NzWV\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Snippet:* `Really really really really loooooooooooooooooooooooooooooooooooog name.txt`\"}},{\"block_id\": \"NOOP_1lwAncRZtR\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"```2020-11-06 17:41:00.250 ERROR 1 --- [ctivity-event-2] i.l.a.s.SlackInteractivityEventService   : Error sending answer questionnaire inline modal!\\n\\nio.levelops.notification.clients.SlackClientException: Response not successful: SlackApiResponse(ok=false, payload=SlackApiViewResponse(view=null), dynamicProperties={response_metadata={messages=[[ERROR] failed to match all allowed schemas [json-pointer:\\/view], [ERROR] failed to match all allowed schemas [json-pointer:\\/view\\/title], [ERROR] must be less than 25 characters [json-pointer:\\/view\\/title\\/text]]}, error=invalid_arguments})\\n\\tat io.levelops.notification.clients.SlackBotClientImpl.expectOkResponse(SlackBotClientImpl.java:37) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.notification.clients.SlackBotClientImpl.openView(SlackBotClientImpl.java:58) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.notification.clients.CachedSlackBotClient.openView(CachedSlackBotClient.java:20) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processQuestionnaireAction(SlackInteractivityEventService.java:310) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processQuestionnaireInteractivityEvent(SlackInteractivityEventService.java:327) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processSlackInteractivityEvent(SlackInteractivityEventService.java:358) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService$$FastClassBySpringCGLIB$$d9d03afa.invoke(<generated>) ~[classes!\\/:na]\\n\\tat org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218) ~[spring-core-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:771) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$0(AsyncExecutionInterceptor.java:115) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat java.base\\/java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[na:na]\\n\\tat java.base\\/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\\n\\tat java.base\\/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\\n\\tat java.base\\/java.lang.Thread.run(Thread.java:830) ~[na:na]```\"}}],\"type\": \"modal\",\"callback_id\": \"view_wi_text_attachment\",\"private_metadata\": \"view_wi_text_attachment~@@@_test~@@@_5a94ff29-3556-43a7-97e2-e367da654d44~@@@_22a3ce26-2178-4c73-bea9-c6b75728d1f7\"}");
    }

    @Test
    public void testWISnippetWithoutMessage() {
        WorkItem wi = WorkItem.builder()
                .id(WI_ID)
                .type(WorkItem.ItemType.MANUAL).ticketType(WorkItem.TicketType.SNIPPET)
                .vanityId("KAFKA-123")
                .title("Snippet from jenkins.dev.levelops.io")
                .reason("https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console")
                .attachment(WorkItem.Attachment.builder().fileName("Really really really really loooooooooooooooooooooooooooooooooooog name.txt").uploadId(UPLOAD_ID).build())
                .build();
        SnippetWorkItemSlackMessageBuilder builder = new SnippetWorkItemSlackMessageBuilder(randomStringGenerator);
        WorkItemSlackMessageBuilder.WorkItemSlackMessages workItemSlackMessages = builder.buildInteractiveMessage(COMPANY, APP_BASE_URL, wi, STATES, uploadIdTextAttachmentsMap, REQUESTOR, null);
        String actual = workItemSlackMessages.getMessage();
        assertThat(actual).isEqualTo("[{\"block_id\": \"NOOP_aJVeRkULBu\",\"type\": \"divider\"},{\"block_id\": \"NOOP_REQUESTOR\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"From viraj@levelops.io,\"}},{\"block_id\": \"NOOP_TITLELEVELOPSWIURL\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"<https://testui1.levelops.io/#/admin/workitems/details?workitem=KAFKA-123|Snippet from jenkins.dev.levelops.io>\"}},{\"block_id\": \"NOOP_URL\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"<https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console|https://jenkins.dev.levelops.io/view/Pipelines/job/maven-test-1/42/console>\"}},{\"block_id\": \"NOOP_SNIPPETPREVIEW\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"```2020-11-06 17:41:00.250 ERROR 1 --- [ctivity-event-2] i.l.a.s.SlackInteractivityEventService   : Error sending answer questionnaire inline modal!\\n\\nio.levelops.notification.clients.SlackClientException: Response not successful: SlackApiResponse(ok=false, payload=SlackApiViewResponse(view=null), dynamicProperties={response_metadata={messages=[[ERROR] failed to match all allowed schemas [json-pointer:\\/view], [ERROR] failed to match all allowed schemas [json-pointer:\\/view\\/title], [ERROR] must be less than 25 characters [json-pointer:\\/view\\/title\\/text]]}...```\"}},{\"block_id\": \"workitem_snippet\",\"type\": \"actions\",\"elements\": [{\"type\": \"button\",\"text\": {\"type\": \"plain_text\",\"text\": \"View Entire Snippet\",\"emoji\": true},\"style\": \"primary\",\"value\": \"view_wi_text_attachment~@@@_test~@@@_5a94ff29-3556-43a7-97e2-e367da654d44~@@@_22a3ce26-2178-4c73-bea9-c6b75728d1f7\",\"action_id\": \"view_wi_text_attachment\"}]},{\"block_id\": \"change_status_snippet_ticket\", \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"`Approval Decision:`\" }, \"accessory\": {\"action_id\": \"change_status_snippet_ticket\",\"type\": \"static_select\", \"placeholder\": { \"type\": \"plain_text\", \"text\": \"Select an item\", \"emoji\": true }, \"options\": [ { \"text\": { \"type\": \"plain_text\", \"text\": \"Closed\", \"emoji\": true }, \"value\": \"CLOSED\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"Open\", \"emoji\": true }, \"value\": \"OPEN\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"In Review\", \"emoji\": true }, \"value\": \"IN_REVIEW\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"New\", \"emoji\": true }, \"value\": \"NEW\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"Not Yet Reviewed\", \"emoji\": true }, \"value\": \"Not Yet Reviewed\" },{ \"text\": { \"type\": \"plain_text\", \"text\": \"WIP\", \"emoji\": true }, \"value\": \"WIP\" } ] } },{\"block_id\": \"forward_snippet_ticket\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"`Forward To:`\"},\"accessory\": {\"action_id\": \"forward_snippet_ticket\",\"type\": \"multi_conversations_select\",\"placeholder\": {\"type\": \"plain_text\",\"text\": \"Select conversations\",\"emoji\": true}}},{\"block_id\":\"assign_snippet_ticket\",\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"`Assign To :`\"},\"accessory\":{\"action_id\":\"assignee_select_snippet_ticket\",\"type\":\"users_select\",\"placeholder\":{\"type\":\"plain_text\",\"text\":\"Select assignee\",\"emoji\":true}}}]");
        assertThat(workItemSlackMessages.getModalMessages().size()).isEqualTo(1);
        assertThat(workItemSlackMessages.getModalMessages().get(0).getLeft()).isEqualTo(UUID.fromString(UPLOAD_ID));
        assertThat(workItemSlackMessages.getModalMessages().get(0).getRight()).isEqualTo("{\"title\": {\"type\": \"plain_text\",\"text\": \"Really really reall...\"},\"blocks\": [{\"block_id\": \"NOOP_gbqB9kp4Tv\",\"type\": \"divider\"},{\"block_id\": \"NOOP_8i5Mv0NzWV\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Snippet:* `Really really really really loooooooooooooooooooooooooooooooooooog name.txt`\"}},{\"block_id\": \"NOOP_1lwAncRZtR\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"```2020-11-06 17:41:00.250 ERROR 1 --- [ctivity-event-2] i.l.a.s.SlackInteractivityEventService   : Error sending answer questionnaire inline modal!\\n\\nio.levelops.notification.clients.SlackClientException: Response not successful: SlackApiResponse(ok=false, payload=SlackApiViewResponse(view=null), dynamicProperties={response_metadata={messages=[[ERROR] failed to match all allowed schemas [json-pointer:\\/view], [ERROR] failed to match all allowed schemas [json-pointer:\\/view\\/title], [ERROR] must be less than 25 characters [json-pointer:\\/view\\/title\\/text]]}, error=invalid_arguments})\\n\\tat io.levelops.notification.clients.SlackBotClientImpl.expectOkResponse(SlackBotClientImpl.java:37) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.notification.clients.SlackBotClientImpl.openView(SlackBotClientImpl.java:58) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.notification.clients.CachedSlackBotClient.openView(CachedSlackBotClient.java:20) ~[notification-service-v0.1.1906.jar!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processQuestionnaireAction(SlackInteractivityEventService.java:310) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processQuestionnaireInteractivityEvent(SlackInteractivityEventService.java:327) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService.processSlackInteractivityEvent(SlackInteractivityEventService.java:358) ~[classes!\\/:na]\\n\\tat io.levelops.api.services.SlackInteractivityEventService$$FastClassBySpringCGLIB$$d9d03afa.invoke(<generated>) ~[classes!\\/:na]\\n\\tat org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218) ~[spring-core-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:771) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$0(AsyncExecutionInterceptor.java:115) ~[spring-aop-5.2.7.RELEASE.jar!\\/:5.2.7.RELEASE]\\n\\tat java.base\\/java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[na:na]\\n\\tat java.base\\/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\\n\\tat java.base\\/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\\n\\tat java.base\\/java.lang.Thread.run(Thread.java:830) ~[na:na]```\"}}],\"type\": \"modal\",\"callback_id\": \"view_wi_text_attachment\",\"private_metadata\": \"view_wi_text_attachment~@@@_test~@@@_5a94ff29-3556-43a7-97e2-e367da654d44~@@@_22a3ce26-2178-4c73-bea9-c6b75728d1f7\"}");
    }
}