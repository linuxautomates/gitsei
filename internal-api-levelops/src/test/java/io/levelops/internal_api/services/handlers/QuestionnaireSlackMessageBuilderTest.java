package io.levelops.internal_api.services.handlers;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.levelops.commons.databases.models.database.questionnaire.QuestionnaireDTO;
import io.levelops.commons.jackson.DefaultObjectMapper;
import io.levelops.commons.utils.ResourceUtils;
import io.levelops.internal_api.services.QuestionnaireSlackMessageBuilder;
import io.levelops.internal_api.services.RandomStringGenerator;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mockito;

import java.io.IOException;

public class QuestionnaireSlackMessageBuilderTest {
    private static final ObjectMapper MAPPER = DefaultObjectMapper.get();
    private final RandomStringGenerator randomStringGenerator = Mockito.mock(RandomStringGenerator.class);

    @Before
    public void setup() {
        Mockito.when(randomStringGenerator.randomString()).thenReturn("aJVeRkULBu","gbqB9kp4Tv","8i5Mv0NzWV","1lwAncRZtR","mTDL2DN2m7","FDGCq38XRE");
    }

    @Test
    public void testBuildInteractiveMessage() throws IOException {
        String templatedText = "<https://testui1.levelops.io//#/admin/workitems/details?workitem=DEFAULT-604254|Quarterly compliance ticket>    <https://testui1.levelops.io//#/admin/answer-questionnaire-page?questionnaire=390a40fb-7cbe-475b-8772-dc8c9eda91ec&tenant=foo|View assessment.>";
        String serialized = ResourceUtils.getResourceAsString("questionnaire/questionnaire_detail.json");
        QuestionnaireDTO questionnaireDetail = MAPPER.readValue(serialized, QuestionnaireDTO.class).toBuilder()
                .questionnaireTemplateName("This title is too loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong")
                .build();

        QuestionnaireSlackMessageBuilder questionnaireSlackMessageBuilder = new QuestionnaireSlackMessageBuilder(randomStringGenerator);
        QuestionnaireSlackMessageBuilder.QuestionnaireSlackMessages blocks = questionnaireSlackMessageBuilder.buildInteractiveMessages("foo", templatedText, questionnaireDetail);
        Assert.assertNotNull(blocks);
        Assert.assertEquals("[{\"block_id\": \"questionnaire_notification\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"<https:\\/\\/testui1.levelops.io\\/\\/#\\/admin\\/workitems\\/details?workitem=DEFAULT-604254|Quarterly compliance ticket>    <https:\\/\\/testui1.levelops.io\\/\\/#\\/admin\\/answer-questionnaire-page?questionnaire=390a40fb-7cbe-475b-8772-dc8c9eda91ec&tenant=foo|View assessment.>\"},\"accessory\": {\"type\": \"button\",\"text\": {\"type\": \"plain_text\",\"text\": \"Answer Inline\",\"emoji\": true},\"value\": \"edit_questionnaire~@@@_foo~@@@_390a40fb-7cbe-475b-8772-dc8c9eda91ec\",\"action_id\": \"edit_questionnaire\"}}]", blocks.getMessage());
        Assert.assertEquals("{\"title\": {\"type\": \"plain_text\",\"text\": \"This title is too l...\"},\"submit\": {\"type\": \"plain_text\",\"text\": \"Submit\"},\"blocks\": [{\"block_id\": \"NOOP_aJVeRkULBu\",\"type\": \"divider\"},{\"block_id\": \"NOOP_80da25b7-f043-4215-b480-7b5833de37b1\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Assessment:* `This title is too loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong`\"}},{\"block_id\": \"NOOP_gbqB9kp4Tv\",\"type\": \"divider\"},{\"block_id\": \"NOOP_06db5640-49e4-4518-8f0b-8e9603766057\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Section:* `S1`\"}},{\"block_id\": \"06db5640-49e4-4518-8f0b-8e9603766057_d5b18833-b68e-46b2-ae5e-02b9b55f5fda\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Q1.1*\"},\"accessory\": {\"type\": \"checkboxes\",\"options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"option 1\"},\"value\": \"option 1\"},{\"text\": {\"type\": \"mrkdwn\",\"text\": \"option 2\"},\"value\": \"option 2\"}],\"initial_options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"option 1\"},\"value\": \"option 1\"},{\"text\": {\"type\": \"mrkdwn\",\"text\": \"option 2\"},\"value\": \"option 2\"}],\"action_id\": \"custom_action_id\"}},{\"block_id\": \"06db5640-49e4-4518-8f0b-8e9603766057_870fa663-426f-4fb3-963b-30e6cd24a9c1\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Question 2*\"},\"accessory\": {\"type\": \"radio_buttons\",\"options\": [{\"text\": {\"type\": \"plain_text\",\"text\": \"option 1\",\"emoji\": true},\"value\": \"option 1\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"option 2\",\"emoji\": true},\"value\": \"option 2\"}],\"initial_option\": {\"text\": {\"type\": \"plain_text\",\"text\": \"option 1\",\"emoji\": true},\"value\": \"option 1\"},\"action_id\": \"custom_action_id\"}},{\"block_id\": \"06db5640-49e4-4518-8f0b-8e9603766057_4672a9b1-2c9b-44d2-86f1-0f030e662243\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Question 3*\"},\"accessory\": {\"type\": \"radio_buttons\",\"options\": [{\"text\": {\"type\": \"plain_text\",\"text\": \"yes\",\"emoji\": true},\"value\": \"yes\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"no\",\"emoji\": true},\"value\": \"no\"}],\"initial_option\": {\"text\": {\"type\": \"plain_text\",\"text\": \"no\",\"emoji\": true},\"value\": \"no\"},\"action_id\": \"custom_action_id\"}},{\"block_id\": \"NOOP_8i5Mv0NzWV\",\"type\": \"divider\"},{\"block_id\": \"NOOP_2e8e8e64-1deb-4684-8eb0-a3cdcefd616b\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Section:* `S2`\"}},{\"block_id\": \"2e8e8e64-1deb-4684-8eb0-a3cdcefd616b_66d26a26-eaff-44b3-b8d9-820a70c2b46b\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Q2.1*\"},\"accessory\": {\"type\": \"radio_buttons\",\"options\": [{\"text\": {\"type\": \"plain_text\",\"text\": \"option 1\",\"emoji\": true},\"value\": \"option 1\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"option 2\",\"emoji\": true},\"value\": \"option 2\"}],\"initial_option\": {\"text\": {\"type\": \"plain_text\",\"text\": \"option 1\",\"emoji\": true},\"value\": \"option 1\"},\"action_id\": \"custom_action_id\"}},{\"block_id\": \"NOOP_1lwAncRZtR\",\"type\": \"divider\"},{\"block_id\": \"NOOP_eaf4b23c-b404-4676-8b30-430ea79248b1\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Section:* `S3`\"}},{\"block_id\": \"eaf4b23c-b404-4676-8b30-430ea79248b1_85b708a8-6590-4d06-a9b1-c8e27ab0c0fb\",\"type\": \"input\",\"element\": {\"type\": \"plain_text_input\",\"multiline\": true,\"action_id\": \"custom_action_id\",\"initial_value\": \"line 1\\nline 2\"},\"label\": {\"type\": \"plain_text\",\"text\": \"Multi line Q1\",\"emoji\": true}},{\"block_id\": \"NOOP_mTDL2DN2m7\",\"type\": \"divider\"},{\"block_id\": \"NOOP_872c9674-f2c6-42d9-ae0d-62add4d36213\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Section:* `test section`\"}},{\"block_id\": \"872c9674-f2c6-42d9-ae0d-62add4d36213_d66e6a16-e067-44d8-9c2d-748559b45b19\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Question 1 \\\"Dangerous\\\" Question?*\"},\"accessory\": {\"type\": \"radio_buttons\",\"options\": [{\"text\": {\"type\": \"plain_text\",\"text\": \"yes\",\"emoji\": true},\"value\": \"yes\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"no\",\"emoji\": true},\"value\": \"no\"}],\"initial_option\": {\"text\": {\"type\": \"plain_text\",\"text\": \"no\",\"emoji\": true},\"value\": \"no\"},\"action_id\": \"custom_action_id\"}},{\"block_id\": \"872c9674-f2c6-42d9-ae0d-62add4d36213_9ae7b8a7-502a-464b-9289-19e1195da8a7\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Question 2 - \\\"Dangerous\\\" Question?*\"},\"accessory\": {\"type\": \"checkboxes\",\"options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"\\\"Dangerous\\\" option 1\"},\"value\": \"\\\"Dangerous\\\" option 1\"},{\"text\": {\"type\": \"mrkdwn\",\"text\": \"Dangerous\\\\n option 2\"},\"value\": \"Dangerous\\\\n option 2\"},{\"text\": {\"type\": \"mrkdwn\",\"text\": \"option 3\"},\"value\": \"option 3\"}],\"initial_options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"\\\"Dangerous\\\" option 1\"},\"value\": \"\\\"Dangerous\\\" option 1\"}],\"action_id\": \"custom_action_id\"}},{\"block_id\": \"872c9674-f2c6-42d9-ae0d-62add4d36213_e5ebc85d-aeee-464b-8c09-b9ccab32d51b\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Question 3 - \\\"Dangerous\\\" Question?*\"},\"accessory\": {\"type\": \"radio_buttons\",\"options\": [{\"text\": {\"type\": \"plain_text\",\"text\": \"\\\"Dangerous\\\" option 1\",\"emoji\": true},\"value\": \"\\\"Dangerous\\\" option 1\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"Dangerous\\\\n option 2\",\"emoji\": true},\"value\": \"Dangerous\\\\n option 2\"},{\"text\": {\"type\": \"plain_text\",\"text\": \"option 3\",\"emoji\": true},\"value\": \"option 3\"}],\"initial_option\": {\"text\": {\"type\": \"plain_text\",\"text\": \"Dangerous\\\\n option 2\",\"emoji\": true},\"value\": \"Dangerous\\\\n option 2\"},\"action_id\": \"custom_action_id\"}},{\"block_id\": \"872c9674-f2c6-42d9-ae0d-62add4d36213_714c4653-2013-4094-9b73-20f55da3f261\",\"type\": \"input\",\"element\": {\"type\": \"plain_text_input\",\"multiline\": true,\"action_id\": \"custom_action_id\",\"initial_value\": \"answer 2\"},\"label\": {\"type\": \"plain_text\",\"text\": \"Question 4 - \\\"Dangerous\\\" Question?\",\"emoji\": true}},{\"block_id\": \"872c9674-f2c6-42d9-ae0d-62add4d36213_50a60d00-7300-4b10-85cb-9e3d0877ec86\",\"type\": \"input\",\"element\": {\"type\": \"plain_text_input\",\"multiline\": true,\"action_id\": \"custom_action_id\",\"initial_value\": \"answer 3\"},\"label\": {\"type\": \"plain_text\",\"text\": \"Question 5 - Dangerous\\\\n Question?\",\"emoji\": true}},{\"block_id\": \"NOOP_FDGCq38XRE\",\"type\": \"divider\"},{\"block_id\": \"NOOP_4d92f53d-061a-416c-8aea-7990835802a2\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Section:* `Checklist Section`\"}},{\"block_id\": \"4d92f53d-061a-416c-8aea-7990835802a2_CHECKLIST\",\"type\": \"section\",\"text\": {\"type\": \"mrkdwn\",\"text\": \"*Checklist*\"},\"accessory\": {\"type\": \"checkboxes\",\"options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"Checklist Question 1\"},\"value\": \"4d92f53d-061a-416c-8aea-7990835802a2_05f2f21b-70e9-49f7-8cad-aeb8b3de9c07\"},{\"text\": {\"type\": \"mrkdwn\",\"text\": \"Checklist Question 2\"},\"value\": \"4d92f53d-061a-416c-8aea-7990835802a2_b61147e6-8b4d-41bb-948b-b87289f19fec\"}],\"initial_options\": [{\"text\": {\"type\": \"mrkdwn\",\"text\": \"Checklist Question 1\"},\"value\": \"4d92f53d-061a-416c-8aea-7990835802a2_05f2f21b-70e9-49f7-8cad-aeb8b3de9c07\"}],\"action_id\": \"custom_action_id\"}}],\"type\": \"modal\",\"callback_id\": \"edit_questionnaire\",\"private_metadata\": \"edit_questionnaire~@@@_foo~@@@_390a40fb-7cbe-475b-8772-dc8c9eda91ec\"}", blocks.getModalMessage());
    }
}