package io.levelops.integrations.rapid7.sources;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import io.levelops.commons.inventory.keys.IntegrationKey;
import io.levelops.ingestion.controllers.generic.IntegrationQuery;
import io.levelops.ingestion.data.BasicData;
import io.levelops.ingestion.data.Data;
import io.levelops.ingestion.exceptions.FetchException;
import io.levelops.ingestion.models.DataQuery;
import io.levelops.ingestion.sources.DataSource;
import io.levelops.integrations.rapid7.client.Rapid7ClientException;
import io.levelops.integrations.rapid7.client.Rapid7ClientFactory;
import io.levelops.integrations.rapid7.models.Rapid7Vulnerability;
import io.levelops.integrations.rapid7.models.api.Rapid7ApiApp;
import io.levelops.integrations.rapid7.models.api.Rapid7ApiModule;
import io.levelops.integrations.rapid7.models.api.Rapid7ApiVulnerability;
import lombok.Builder;
import lombok.Value;
import lombok.extern.log4j.Log4j2;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.Validate;
import org.apache.commons.lang3.tuple.Pair;

import javax.annotation.Nonnull;
import java.util.Optional;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;
import java.util.stream.Stream;

@Log4j2
public class Rapid7VulnerabilityDataSource implements DataSource<Rapid7Vulnerability, Rapid7VulnerabilityDataSource.Rapid7VulnerabilityQuery> {

    private final Rapid7ClientFactory clientFactory;

    private final LoadingCache<Pair<IntegrationKey, String>, Rapid7ApiApp> appCache = CacheBuilder.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(1, TimeUnit.HOURS)
            .build(new CacheLoader<>() {
                @Override
                public Rapid7ApiApp load(@Nonnull Pair<IntegrationKey, String> key) throws Exception {
                    return clientFactory.get(key.getKey()).getApp(key.getRight());
                }
            });

    private final LoadingCache<Pair<IntegrationKey, String>, Rapid7ApiModule> moduleCache = CacheBuilder.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(1, TimeUnit.HOURS)
            .build(new CacheLoader<>() {
                @Override
                public Rapid7ApiModule load(@Nonnull Pair<IntegrationKey, String> key) throws Exception {
                    return clientFactory.get(key.getKey()).getModule(key.getRight());
                }
            });

    public Rapid7VulnerabilityDataSource(Rapid7ClientFactory clientFactory) {
        this.clientFactory = clientFactory;
    }

    @Override
    public Data<Rapid7Vulnerability> fetchOne(Rapid7VulnerabilityQuery query) throws FetchException {
        throw new UnsupportedOperationException("FetchOne not supported");
    }

    @Override
    public Stream<Data<Rapid7Vulnerability>> fetchMany(Rapid7VulnerabilityQuery query) throws FetchException {
        Validate.notNull(query, "query cannot be null.");
        Validate.notNull(query.getIntegrationKey(), "query.getIntegrationKey() cannot be null.");
        try {
            var response = clientFactory.get(query.getIntegrationKey()).getVulnerabilities(query.getPageNumber());
            if (CollectionUtils.isEmpty(response.getData())) {
                return Stream.empty();
            }
            return response.getData()
                    .stream()
                    .map(apiResponse -> normalizeVulnerability(query.getIntegrationKey(), apiResponse))
                    .map(BasicData.mapper(Rapid7Vulnerability.class));
        } catch (Rapid7ClientException e) {
            throw new FetchException("Could not fetch Rapid7 vulnerabilities", e);
        }
    }

    private Rapid7Vulnerability normalizeVulnerability(IntegrationKey integrationKey, Rapid7ApiVulnerability apiVulnerability) {
        String appId = apiVulnerability.getApp() != null ? apiVulnerability.getApp().getId() : null;
        String moduleId = apiVulnerability.getModuleId().orElse(null);
        Optional<Rapid7ApiApp> appDetails = retrieveAppDetails(integrationKey, appId);
        Optional<Rapid7ApiModule> moduleDetails = retrieveModuleDetails(integrationKey, moduleId);
        return Rapid7Vulnerability.builder()
                .id(apiVulnerability.getId())
                .appId(appId)
                .appName(appDetails.map(Rapid7ApiApp::getName).orElse(null))
                .rootCause(apiVulnerability.getRootCause())
                .moduleId(moduleId)
                .moduleName(moduleDetails.map(Rapid7ApiModule::getName).orElse(null))
                .moduleDescription(moduleDetails.map(Rapid7ApiModule::getDescription).orElse(null))
                .build();
    }

    private Optional<Rapid7ApiApp> retrieveAppDetails(IntegrationKey integrationKey, String appId) {
        if (StringUtils.isEmpty(appId)) {
            return Optional.empty();
        }
        try {
            return Optional.ofNullable(appCache.get(Pair.of(integrationKey, appId)));
        } catch (ExecutionException e) {
            log.warn("Failed to get app details", e);
        }
        return Optional.empty();
    }

    private Optional<Rapid7ApiModule> retrieveModuleDetails(IntegrationKey integrationKey, String moduleId) {
        if (StringUtils.isEmpty(moduleId)) {
            return Optional.empty();
        }
        try {
            return Optional.ofNullable(moduleCache.get(Pair.of(integrationKey, moduleId)));
        } catch (ExecutionException e) {
            log.warn("Failed to get module details", e);
        }
        return Optional.empty();
    }


    @Value
    @Builder(toBuilder = true)
    @JsonDeserialize(builder = Rapid7VulnerabilityQuery.Rapid7VulnerabilityQueryBuilder.class)
    public static class Rapid7VulnerabilityQuery implements IntegrationQuery, DataQuery {
        @JsonProperty("integration_key")
        IntegrationKey integrationKey;

        @JsonProperty("page_number")
        Integer pageNumber;
    }
}
