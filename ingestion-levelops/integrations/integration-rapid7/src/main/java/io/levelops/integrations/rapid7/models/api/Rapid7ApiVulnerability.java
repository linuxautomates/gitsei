package io.levelops.integrations.rapid7.models.api;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.ToString;
import lombok.Value;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;

import java.util.List;
import java.util.Optional;

@Getter
@EqualsAndHashCode
@NoArgsConstructor
@AllArgsConstructor
@ToString
@Builder(toBuilder = true)
@JsonDeserialize(builder = Rapid7ApiVulnerability.Rapid7ApiVulnerabilityBuilder.class)
public class Rapid7ApiVulnerability {

    @JsonProperty("id")
    String id;

    @JsonProperty("app")
    App app;

    @JsonProperty("root_cause")
    RootCause rootCause;

    @JsonProperty("severity")
    String severity;

    @JsonProperty("status")
    String status;

    @JsonProperty("variances")
    List<Variance> variances;

    /**
     * Returns the attack module of the first variance.
     * NB: it seems that vulnerabilities are grouped by attack module so all the variances share the same module id.
     */
    @JsonIgnore
    public Optional<String> getModuleId() {
        if (CollectionUtils.isEmpty(variances)) {
            return Optional.empty();
        }
        Variance variance = variances.get(0);
        if (variance == null || variance.getModule() == null || StringUtils.isEmpty(variance.getModule().getId())) {
            return Optional.empty();
        }
        return Optional.ofNullable(variance.getModule().getId());
    }

    @Value
    @Builder(toBuilder = true)
    @JsonDeserialize(builder = App.AppBuilder.class)
    public static class App {
        @JsonProperty("id")
        String id;
    }

    @Value
    @Builder(toBuilder = true)
    @JsonDeserialize(builder = RootCause.RootCauseBuilder.class)
    public static class RootCause {
        @JsonProperty("url")
        String url;
        @JsonProperty("parameter")
        String parameter;
        @JsonProperty("method")
        String method;
    }

    @Value
    @Builder(toBuilder = true)
    @JsonDeserialize(builder = Variance.VarianceBuilder.class)
    public static class Variance {
        @JsonProperty("original_value")
        String originalValue;

        @JsonProperty("original_exchange")
        Exchange originalExchange;

        @JsonProperty("attack")
        Attack attack;

        @JsonProperty("module")
        Module module;

        @JsonProperty("attack_value")
        String attackValue;

        @JsonProperty("attack_exchanges")
        List<Exchange> attackExchanges;

        @JsonProperty("message")
        String message;

        @Value
        @Builder(toBuilder = true)
        @JsonDeserialize(builder = Exchange.ExchangeBuilder.class)
        public static class Exchange {
            @JsonProperty("request")
            String request;
            @JsonProperty("response")
            String response;
        }

        @Value
        @Builder(toBuilder = true)
        @JsonDeserialize(builder = Attack.AttackBuilder.class)
        public static class Attack {
            @JsonProperty("id")
            String id;
        }

        @Value
        @Builder(toBuilder = true)
        @JsonDeserialize(builder = Module.ModuleBuilder.class)
        public static class Module {
            @JsonProperty("id")
            String id;
        }
    }

}
