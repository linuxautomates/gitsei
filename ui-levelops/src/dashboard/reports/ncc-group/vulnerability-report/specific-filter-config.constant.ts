import { WIDGET_CONFIGURATION_KEYS } from "constants/widgets";
import APIFilterContainer from "dashboard/graph-filters/components/GenericFilterComponents/APIFilter.container";
import UniversalInputFilterWrapper from "dashboard/graph-filters/components/GenericFilterComponents/UniversalInputFilter";
import UniversalSelectFilterWrapper from "dashboard/graph-filters/components/GenericFilterComponents/UniversalSelectFilterWrapper";
import UniversalTimeBasedFilter from "dashboard/graph-filters/components/GenericFilterComponents/UniversalTimeBasedFilter";
import { withDeleteAPIProps } from "dashboard/report-filters/common/common-api-filter-props";
import { extractFilterAPIData } from "dashboard/report-filters/helper";
import { get } from "lodash";
import {
  ApiDropDownData,
  baseFilterConfig,
  DropDownData,
  LevelOpsFilter,
  LevelOpsFilterTypes
} from "model/filters/levelopsFilters";
import { toTitleCase } from "utils/stringUtils";
import { NCC_GROUP_FILTER_KEY_MAPPING, SUPPORTED_FILTERS } from "../constant";
import { STACK_OPTIONS } from "./constants";

const commonNccGroupFilters = SUPPORTED_FILTERS.filter((filter: string) => filter !== "component").map(
  (filter: string) => ({
    key: filter,
    label: toTitleCase(filter.replace(/_/g, " "))
  })
);

export const StackFilterConfig: LevelOpsFilter = {
  id: "stacks",
  renderComponent: UniversalSelectFilterWrapper,
  label: "Stacks",
  beKey: "stacks",
  labelCase: "title_case",
  filterMetaData: {
    clearSupport: true,
    options: STACK_OPTIONS,
    sortOptions: true
  } as DropDownData,
  tab: WIDGET_CONFIGURATION_KEYS.METRICS
};

export const nccGroupCommonFiltersConfig: LevelOpsFilter[] = [
  baseFilterConfig(NCC_GROUP_FILTER_KEY_MAPPING["component"], {
    renderComponent: UniversalSelectFilterWrapper,
    apiContainer: APIFilterContainer,
    label: "Component",
    tab: WIDGET_CONFIGURATION_KEYS.FILTERS,
    type: LevelOpsFilterTypes.API_DROPDOWN,
    labelCase: "title_case",
    deleteSupport: true,
    partialSupport: true,
    excludeSupport: true,
    partialKey: "component",
    supportPaginatedSelect: true,
    apiFilterProps: (args: any) => ({ withDelete: withDeleteAPIProps(args) }),
    filterMetaData: {
      selectMode: "multiple",
      uri: "ncc_group_issues_values",
      method: "list",
      payload: (args: Record<string, any>) => {
        return {
          integration_ids: get(args, "integrationIds", []),
          fields: ["components"],
          filter: { integration_ids: get(args, "integrationIds", []) }
        };
      },
      options: (args: any) => {
        const data = extractFilterAPIData(args, "component");
        return data
          ?.map((item: any) => ({
            label: item.value ?? item.key,
            value: item.key
          }))
          .filter((item: { label: string; value: string }) => !!item.value);
      },
      specialKey: "component",
      sortOptions: true,
      createOption: true
    } as ApiDropDownData
  }),
  ...commonNccGroupFilters.map((item: { key: string; label: string }) =>
    baseFilterConfig(item.key, {
      renderComponent: UniversalSelectFilterWrapper,
      apiContainer: APIFilterContainer,
      label: item.label,
      tab: WIDGET_CONFIGURATION_KEYS.FILTERS,
      type: LevelOpsFilterTypes.API_DROPDOWN,
      labelCase: "title_case",
      deleteSupport: true,
      partialSupport: true,
      excludeSupport: true,
      partialKey: item.key,
      supportPaginatedSelect: true,
      apiFilterProps: (args: any) => ({ withDelete: withDeleteAPIProps(args) }),
      filterMetaData: {
        selectMode: "multiple",
        uri: "ncc_group_issues_values",
        method: "list",
        payload: (args: Record<string, any>) => {
          return {
            integration_ids: get(args, "integrationIds", []),
            fields: [item.key],
            filter: { integration_ids: get(args, "integrationIds", []) }
          };
        },
        options: (args: any) => {
          const data = extractFilterAPIData(args, item.key);
          return data
            ?.map((item: any) => ({
              label: item.additional_key ?? item.key,
              value: item.key
            }))
            .filter((item: { label: string; value: string }) => !!item.value);
        },
        specialKey: item.key,
        sortOptions: true,
        createOption: true
      } as ApiDropDownData
    })
  )
];

export const IngestedInFilterConfig: LevelOpsFilter = {
  id: "ncc_ingested_at",
  renderComponent: UniversalTimeBasedFilter,
  label: "Ingested In",
  beKey: "ingested_at",
  labelCase: "title_case",
  deleteSupport: true,
  filterMetaData: {
    slicing_value_support: true,
    selectMode: "default",
    options: []
  },
  tab: WIDGET_CONFIGURATION_KEYS.FILTERS
};

export const CreatedInFilterConfig: LevelOpsFilter = {
  id: "ncc_created_in",
  renderComponent: UniversalTimeBasedFilter,
  label: "Created In",
  beKey: "created_in",
  labelCase: "title_case",
  deleteSupport: true,
  filterMetaData: {
    slicing_value_support: true,
    selectMode: "default",
    options: []
  },
  tab: WIDGET_CONFIGURATION_KEYS.FILTERS
};

export const LastReportFilterConfig: LevelOpsFilter = {
  id: "n_last_reports",
  renderComponent: UniversalInputFilterWrapper,
  label: "Last Reports",
  beKey: "n_last_reports",
  labelCase: "title_case",
  defaultValue: 1,
  filterMetaData: {
    type: "number"
  },
  deleteSupport: true,
  apiFilterProps: (args: any) => ({ withDelete: withDeleteAPIProps(args) }),
  tab: WIDGET_CONFIGURATION_KEYS.FILTERS
};
